<h2 class="cart-title">Mis productos</h2>
<div class="wrapper">
    @for(product of productsInCart; track product.id){
        <div class="cart-product-card">
            <div class="img-container" (click)="viewProductDetail(product.id)">
                <img class="product-image" [src]="product.urlImg" [alt]="product.description">
            </div>
            <div class="cart-card-content">
                <button class="cart-btn-remove-product remove" (click)="removeItemFromCart(product)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M4 4L12 12M12 4L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <p>{{product.description}}</p>
                <p>{{product.brand}}</p>
                <p class="cart-product-price">{{product.price | currency:"ARS"}}</p>
                <div class="cart-product-footer">
                    <div class="btns-container">
                        @if(product.quantity && product.quantity>1){
                            <button class="cart-btns-more-less" (click)="decreaseProductFromCart(product)">-</button>
                        }@else {
                            <button class="cart-btns-more-less remove" (click)="decreaseProductFromCart(product)" aria-label="Eliminar del carrito">
                                <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="currentColor">
                                  <path d="M3 6h18v2H3V6zm2 3h14l-1.5 12.5a2 2 0 0 1-2 1.5H8a2 2 0 0 1-2-1.5L4.5 9zm5 2v8h2v-8H9zm4 0v8h2v-8h-2zM9 4V3h6v1h5v2H4V4h5z"/>
                                </svg>
                            </button>
                        }
                        <span>{{product.quantity}}</span>
                        <button class="cart-btns-more-less" (click)="addProductToCart(product)">+</button>
                    </div>
                    @if(product.quantity && product.quantity>=1){
                        <p style="font-size: 0.85rem;">Subtotal <span class="cart-product-subtotal">{{(product.price * product.quantity * (1- (product.discount1 ?? 0)/100) * (1- (product.discount2 ?? 0)/100) * (1- (product.discount3 ?? 0)/100)) | currency:"ARS"}}</span></p>
                    }
                </div>

            </div>  
        </div>
    }
    @if(productsInCart.length > 0){
        <div class="order-summary">
            <p>Costo de envío: <span>{{0 | currency:"ARS"}}</span></p>
            <p>Total: <span>{{subtotal | currency:"ARS"}}</span></p>
        </div>
        <div class="cart-options">
            <button class="send-order-cart-btn" (click)="openForm()"><i class="fab fa-whatsapp"></i>Realizar Pedido</button>
            <button class="clear-cart-btn" (click)="cleanCart()">Vaciar Carrito</button>
            <button class="continue-btn" (click)="routerSvc.navigate(['products'])">Seguir comprando</button>
        </div>
    }
</div>


@if(showModal){
  <div class="modal-backdrop" (click)="closeModal()"></div>
  <div class="custom-modal">
    <form [formGroup]="form" (ngSubmit)="onSubmitForm()">
      <h3>Datos del cliente</h3>

      <div class="input-group">
        <input type="text" placeholder=" " formControlName="nombre" required [class.invalid]="form.get('nombre')?.invalid && form.get('nombre')?.touched" />
        <label [class.invalid]="form.get('nombre')?.invalid && form.get('nombre')?.touched">Nombre*</label>
        @if (form.get('nombre')?.invalid && form.get('nombre')?.touched) {
            <small style="color: red; margin-top: 4px;">
                El nombre es obligatorio
            </small>
        }
      </div>

      <div class="input-group">
        <input type="text" placeholder=" " formControlName="apellido" required [class.invalid]="form.get('apellido')?.invalid && form.get('apellido')?.touched" />
        <label [class.invalid]="form.get('apellido')?.invalid && form.get('apellido')?.touched">Apellido*</label>
        @if (form.get('apellido')?.invalid && form.get('apellido')?.touched) {
            <small style="color: red; margin-top: 4px;">
                El apellido es obligatorio
            </small>
        }
      </div>

      
      <div class="select-form">
          <label [class.invalid]="form.get('formaPago')?.invalid && form.get('formaPago')?.touched">Forma de pago</label>
          <select formControlName="formaPago" required [class.invalid]="form.get('formaPago')?.invalid && form.get('formaPago')?.touched">
            <option value="Efectivo" selected>Efectivo</option>
            <option value="Transferencia">Transferencia</option>
            <option value="Tarjeta de Débito">Tarjeta de Débito</option>
            <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
        </select>
        @if (form.get('formaPago')?.invalid && form.get('formaPago')?.touched) {
            <small style="color: red; margin-top: 4px;">
                La forma de pago es obligatoria
            </small>
        }
    </div>
    
        @if(form.get("formaPago")?.value !== "Efectivo"){
            <div class="input-group">
            <input type="text" placeholder=" " formControlName="documento" required [class.invalid]="form.get('documento')?.invalid && form.get('documento')?.touched" />
            <label [class.invalid]="form.get('documento')?.invalid && form.get('documento')?.touched">Documento (DNI)*</label>
            @if (form.get('documento')?.invalid && form.get('documento')?.touched) {
                <small style="color: red; margin-top: 4px;">
                    El documento DNI es obligatorio
                </small>
            }
            </div>
        }
        <div class="radio-form">
            <label>Lugar de entrega</label>
            <div class="radio-group">
                <label>
                <input type="radio" formControlName="tipoDireccion" value="estandar" /> 
                <strong>{{pos?.puntoDeVenta}}</strong> {{"("+pos?.direccion + ", " + pos?.localidad + ")" }}
                </label>
                
                @if (pos && pos.id != "giza") {
                    <label>
                    <input type="radio" formControlName="tipoDireccion" value="giza" />
                    <strong>{{ gizaPos?.puntoDeVenta }}</strong> {{"("+gizaPos?.direccion + ", " + gizaPos?.localidad +")"}} 
                    </label>
                }
                
                <label>
                <input type="radio" formControlName="tipoDireccion" value="personalizada" />
                Especificar dirección
                </label>
            </div>
        </div>

        <!--
            -->
        @if(form.get('tipoDireccion')?.value === 'personalizada') {
            <div class="input-group">
                <input type="text"
                    placeholder=" "
                    formControlName="direccion"
                    required
                    [class.invalid]="form.get('direccion')?.invalid && form.get('direccion')?.touched" />
                <label>Dirección personalizada*</label>
                @if (form.get('direccion')?.invalid && form.get('direccion')?.touched) {
                <small style="color: red;">La dirección es obligatoria</small>
                }
            </div>

            <div class="select-form">
                <label [class.invalid]="form.get('localidad')?.invalid && form.get('localidad')?.touched">Localidad</label>
                <select formControlName="localidad" required [class.invalid]="form.get('localidad')?.invalid && form.get('localidad')?.touched">
                    <option value="San Nicolás de los Arroyos" selected>San Nicolás de los Arroyos</option>
                    <option value="Ramallo">Ramallo</option>
                    <option value="Villa Constitución">Villa Constitución</option>
                    <option value="Baradero">Baradero</option>
                    <option value="Rosario">Rosario</option>
                    <option value="San Pedro">San Pedro</option>
                </select>
                @if (form.get('localidad')?.invalid && form.get('localidad')?.touched) {
                    <small style="color: red; margin-top: 4px;">
                        La localidad es obligatoria
                    </small>
                }
            </div>
        }

        <div class="input-group">
            <input type="text" placeholder=" " formControlName="horarioDeEntrega" required [class.invalid]="form.get('horarioDeEntrega')?.invalid && form.get('horarioDeEntrega')?.touched" />
            <label [class.invalid]="form.get('horarioDeEntrega')?.invalid && form.get('horarioDeEntrega')?.touched">Horario de entrega*</label>
            @if (form.get('horarioDeEntrega')?.invalid && form.get('horarioDeEntrega')?.touched) {
                <small style="color: red; margin-top: 4px;">
                    El horario de entrega es obligatorio
                </small>
            }
        </div>

      <div class="cart-options">
        <button class="send-order-cart-btn" type="submit"><i class="fab fa-whatsapp"></i>Enviar Pedido</button>
        <button class="clear-cart-btn" type="button" (click)="closeModal()">Cancelar</button>
      </div>
    </form>
  </div>
}

